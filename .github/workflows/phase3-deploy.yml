# .github/workflows/phase3-deploy.yml
name: Phase 3 Deployment

on:
  push:
    branches: [phase3-production, main]
  pull_request:
    branches: [main]

env:
  FLUTTER_VERSION: '3.22.0'
  NODE_VERSION: '20'

jobs:
  # Test job runs on all PRs
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          
      - name: Install dependencies
        run: |
          cd backend
          npm ci
          
      - name: Run tests
        run: |
          cd backend
          npm test
          
      - name: Check database migrations
        run: |
          cd backend
          npx prisma migrate diff \
            --from-migrations ./prisma/migrations \
            --to-schema-datamodel ./prisma/schema.prisma \
            --exit-code

  deploy-windows:
    runs-on: windows-latest
    needs: test
    if: github.ref == 'refs/heads/phase3-production'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
          
      - name: Build Flutter Desktop
        run: |
          cd apps/desktop
          flutter pub get
          flutter build windows --release
          
      - name: Build System Tray
        run: |
          cd apps/desktop/windows/system_tray/TelePromptTray
          dotnet build -c Release
          
      - name: Sign with Certificate
        if: github.event_name == 'push'
        run: |
          $cert = Get-PfxCertificate -FilePath ${{ secrets.WINDOWS_CERT_PATH }}
          Set-AuthenticodeSignature -FilePath "apps/desktop/build/windows/runner/Release/teleprompt_pro.exe" -Certificate $cert
          
      - name: Create MSIX Package
        run: |
          cd apps/desktop
          flutter pub run msix:create
          
      - name: Upload MSIX Artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-msix
          path: apps/desktop/build/windows/runner/Release/**/*.msix
          
      - name: Deploy to Microsoft Store
        if: github.event_name == 'push'
        run: |
          # Install Store CLI
          winget install Microsoft.StoreCLI
          
          # Submit to Partner Center
          storebroker submit `
            -AppId ${{ secrets.MS_STORE_APP_ID }} `
            -Package "apps/desktop/build/windows/runner/Release/*.msix" `
            -Credentials ${{ secrets.MS_PARTNER_CENTER_CREDS }}

  deploy-web:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/phase3-production'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Build PWA
        run: |
          cd apps/web
          flutter pub get
          flutter build web --release --web-renderer html
          
      - name: Optimize Assets
        run: |
          cd apps/web/build/web
          # Compress JavaScript
          find . -name "*.js" -exec terser {} -o {} -c -m \;
          # Compress CSS
          find . -name "*.css" -exec csso {} -o {} \;
          # Generate WebP images
          find . -name "*.png" -o -name "*.jpg" | while read img; do
            cwebp "$img" -o "${img%.*}.webp"
          done
          
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:8080
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Deploy to AWS S3/CloudFront
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Sync to S3
          aws s3 sync apps/web/build/web/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "service-worker.js"
            
          # Upload HTML with no cache
          aws s3 sync apps/web/build/web/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "service-worker.js" \
            --cache-control "no-cache, no-store, must-revalidate"
            
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
            
      - name: Update Service Worker Version
        run: |
          VERSION=$(date +%s)
          sed -i "s/CACHE_VERSION = '.*'/CACHE_VERSION = '$VERSION'/" apps/web/build/web/service-worker.js
          aws s3 cp apps/web/build/web/service-worker.js \
            s3://${{ secrets.S3_BUCKET_NAME }}/service-worker.js \
            --cache-control "no-cache"

  deploy-mobile:
    strategy:
      matrix:
        platform: [ios, android]
        include:
          - platform: ios
            os: macos-latest
            build_cmd: 'flutter build ipa --release'
            artifact_path: 'build/ios/ipa/*.ipa'
          - platform: android
            os: ubuntu-latest
            build_cmd: 'flutter build appbundle --release'
            artifact_path: 'build/app/outputs/bundle/release/*.aab'
    
    runs-on: ${{ matrix.os }}
    needs: test
    if: github.ref == 'refs/heads/phase3-production'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          
      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '11'
          
      - name: Setup Ruby (iOS only)
        if: matrix.platform == 'ios'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          
      - name: Install Dependencies
        run: |
          cd apps/mobile
          flutter pub get
          
      - name: Configure Keystore (Android)
        if: matrix.platform == 'android'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > apps/mobile/android/app/upload-keystore.jks
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > apps/mobile/android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> apps/mobile/android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> apps/mobile/android/key.properties
          echo "storeFile=upload-keystore.jks" >> apps/mobile/android/key.properties
          
      - name: Configure Certificates (iOS)
        if: matrix.platform == 'ios'
        run: |
          cd apps/mobile/ios
          bundle install
          bundle exec fastlane match appstore --readonly
          
      - name: Build Mobile App
        run: |
          cd apps/mobile
          ${{ matrix.build_cmd }}
          
      - name: Run Integration Tests
        run: |
          cd apps/mobile
          flutter test integration_test
          
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.platform }}-build
          path: apps/mobile/${{ matrix.artifact_path }}
          
      - name: Deploy to App Store (iOS)
        if: matrix.platform == 'ios'
        run: |
          cd apps/mobile/ios
          bundle exec fastlane deploy
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
          
      - name: Deploy to Play Store (Android)
        if: matrix.platform == 'android'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.teleprompt.pro
          releaseFiles: apps/mobile/build/app/outputs/bundle/release/*.aab
          track: production
          status: completed
          
  deploy-backend:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/phase3-production'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Build Docker Image
        run: |
          cd backend
          docker build -t teleprompt-api .
          
      - name: Push to ECR
        run: |
          aws ecr get-login-password | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          docker tag teleprompt-api:latest ${{ secrets.ECR_REGISTRY }}/teleprompt-api:latest
          docker push ${{ secrets.ECR_REGISTRY }}/teleprompt-api:latest
          
      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster teleprompt-cluster \
            --service teleprompt-api-service \
            --force-new-deployment
            
      - name: Run Database Migrations
        run: |
          aws ecs run-task \
            --cluster teleprompt-cluster \
            --task-definition teleprompt-migrate \
            --network-configuration "awsvpcConfiguration={subnets=[${{ secrets.SUBNET_IDS }}],securityGroups=[${{ secrets.SECURITY_GROUP_ID }}]}"